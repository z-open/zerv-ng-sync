!function(){"use strict";angular.module("sync",["socketio-auth"])}(),function(){"use strict";function n(){function n(n){c=n}function t(){return c}function e(){return u.length}function r(n){u.push({timestamp:Date.now(),collect:n}),s||a.schedule()}function i(){return c?(s=!0,void setTimeout(function(){a.run(),u.length>0?i():s=!1},1e3*c)):void a.run()}function o(){for(var n=Date.now()-1e3*c;u.length>0&&u[0].timestamp<=n;)u.shift().collect()}var u=[],c=2,s=!1,a={setSeconds:n,getSeconds:t,dispose:r,schedule:i,run:o,getItemCount:e};return a}angular.module("sync").factory("$syncGarbageCollector",n)}(),function(){"use strict";function n(){function n(r,i,o){if(!r)return i;var u={};for(var c in i)_.isArray(i[c])?u[c]=t(r[c],i[c],o):_.isFunction(i[c])?u[c]=i[c]:_.isObject(i[c])&&!_.isDate(i[c])?u[c]=n(r[c],i[c],o):u[c]=i[c];return e(r),_.assign(r,u),r}function t(t,e,r){if(!t)return e;var i=[];return e.forEach(function(e){if("NONE"===r)i.push(e);else if(!_.isArray(e)&&_.isObject(e))if(angular.isDefined(e.id))i.push(n(_.find(t,function(n){return n.id.toString()===e.id.toString()}),e,r));else{if(r)throw new Error("objects in array must have an id otherwise we can't maintain the instance reference. "+JSON.stringify(e));i.push(e)}else i.push(e)}),t.length=0,Array.prototype.push.apply(t,i),t}function e(n){Object.keys(n).forEach(function(t){delete n[t]})}return{update:n,clearObject:e}}angular.module("sync").factory("$syncMerge",n)}(),function(){"use strict";function n(){function n(n){if(!_.isObject(n))return n;var t=_.join(_.map(n,function(n){return n}),"~");return t}function t(n){}function e(n){}var r;this.setDebug=function(n){r=n},this.$get=["$rootScope","$q","$socketio","$syncGarbageCollector","$syncMerge",function(r,i,o,u,c){function s(n,e,r){var o=i.defer(),u=f(n).setObjectClass(r),c=setTimeout(function(){u.ready||(u.destroy(),t("Attempt to subscribe to publication "+n+" failed"),o.reject("SYNC_TIMEOUT"))},1e3*m);return u.setParameters(e).waitForDataReady().then(function(){clearTimeout(c),o.resolve(u)})["catch"](function(){clearTimeout(c),u.destroy(),o.reject("Failed to subscribe to publication "+n+" failed")}),o.promise}function a(){return m}function f(n,t){return new h(n,t)}function d(){o.on("SYNC_NOW",function(n,e){t("Syncing with subscription [name:"+n.name+", id:"+n.subscriptionId+" , params:"+JSON.stringify(n.params)+"]. Records:"+n.records.length+"["+(n.diff?"Diff":"All")+"]");var r=v[n.name];if(r)for(var i in r)r[i](n);e("SYNCED")})}function l(n,t){var e=p++,r=v[n];return r||(v[n]=r={}),r[e]=t,function(){delete r[e]}}function h(s,a){function f(){_()}function d(n){return rn&&rn(),rn=G(n),hn}function h(n){return n&&hn.syncOff(),hn}function v(n){return en=n,hn}function p(n){return tn?hn:(an=n,on=function(n){return new an(n)},w(Q),hn)}function m(){return an}function b(n,t){return ln&&angular.equals(n||{},yn)?hn:(_(),Q||(Z.length=0),yn=n||{},t=t||{},angular.isDefined(t.single)&&w(t.single),D(),hn)}function S(){return D().then(function(){return hn})}function O(){return D()}function w(n){if(tn)return hn;var t;return Q=n,n?(t=B,Z=an?new an({}):{}):(t=H,Z=[]),X=function(n){try{t(n)}catch(e){throw e.message="Received Invalid object from publication ["+s+"]: "+JSON.stringify(n)+". DETAILS: "+e.message,e}},hn}function j(){return Z}function N(){return D(),hn}function _(){return tn&&tn.resolve(j()),ln&&(J(),ln=!1,t("Sync "+s+" off. Params:"+JSON.stringify(yn)),cn&&(cn(),cn=null),un&&(un(),un=null)),hn}function D(){return ln?tn.promise:(tn=i.defer(),nn=!1,t("Sync "+s+" on. Params:"+JSON.stringify(yn)),ln=!0,I(),E(),tn.promise)}function $(){return ln}function E(){cn||(C(),T())}function R(n){return tn?hn:(sn&&sn(),dn=n,sn=dn.$on("$destroy",f),hn)}function C(n){setTimeout(function(){un=dn.$on("user_connected",function(){e("Resyncing after network loss to "+s),I()})},n?0:2e3)}function I(){o.fetch("sync.subscribe",{version:g,id:fn,publication:s,params:yn}).then(function(n){fn=n})}function J(){fn&&(o.fetch("sync.unsubscribe",{version:g,id:fn}),fn=null)}function T(){cn=l(s,function(n){(fn===n.subscriptionId||!fn&&A(n.params))&&(n.diff||(vn={},Q||(Z.length=0)),F(n.records),nn||(nn=!0,tn.resolve(j())))})}function A(n){if(!yn||0==Object.keys(yn).length)return!0;var t=!0;for(var e in n)if(n[e]!==yn[e]){t=!1;break}return t}function F(n){var t,e=[];hn.ready=!1,n.forEach(function(n){n.remove?x(n):t=z(n)?Y(n):U(n),t&&e.push(t)}),hn.ready=!0,Q?pn.notify("ready",j()):pn.notify("ready",j(),e)}function k(){return this.ready}function P(n){return pn.on("add",n)}function M(n){return pn.on("update",n)}function q(n){return pn.on("remove",n)}function G(n){return pn.on("ready",n)}function U(n){return e("Sync -> Inserted New record #"+JSON.stringify(n.id)+" for subscription to "+s),K(n),X(on?on(n):n),pn.notify("add",n),n}function Y(n){var t=z(n);return K(n)<=K(t)?null:(e("Sync -> Updated record #"+JSON.stringify(n.id)+" for subscription to "+s),X(on?on(n):n),pn.notify("update",n),n)}function x(n){var t=z(n);(!t||K(n)>K(t))&&(e("Sync -> Removed #"+JSON.stringify(n.id)+" for subscription to "+s),n.removed=!0,X(n),t&&(pn.notify("remove",n),L(n)))}function L(t){u.dispose(function(){var e=z(t);e&&t.revision>=e.revision&&delete vn[n(t.id)]})}function V(n){return!!z(n)}function W(t){vn[n(t.id)]=t}function z(t){return vn[n(t.id)]}function B(n){W(n),n.remove?c.clearObject(Z):c.update(Z,n,en)}function H(n){var t=z(n);t?(c.update(t,n,en),n.removed&&Z.splice(Z.indexOf(t),1)):(W(n),n.removed||Z.push(n))}function K(n){if(angular.isDefined(n.revision))return n.revision;if(angular.isDefined(n.timestamp))return n.timestamp;throw new Error("Sync requires a revision or timestamp property in received "+(an?"object ["+an.name+"]":"record"))}var Q,X,Z,nn,tn,en,rn,on,un,cn,sn,an,fn,dn,ln=!1,hn=this,yn={},vn={},pn=new y;this.ready=!1,this.syncOn=N,this.syncOff=_,this.setOnReady=d,this.onReady=G,this.onUpdate=M,this.onAdd=P,this.onRemove=q,this.getData=j,this.setParameters=b,this.waitForDataReady=O,this.waitForSubscriptionReady=S,this.setForce=h,this.isSyncing=$,this.isReady=k,this.setSingle=w,this.setObjectClass=p,this.getObjectClass=m,this.setStrictMode=v,this.attach=R,this.destroy=f,this.isExistingStateFor=V,w(!1),R(a||r)}function y(){function n(n,t,r){var i=e[n];i&&_.forEach(i,function(n,e){n(t,r)})}function t(n,t){var i=e[n];i||(i=e[n]={});var o=r++;return i[o++]=t,function(){delete i[o]}}var e={},r=0;this.notify=n,this.on=t}var v={},p=0,m=8,g="1.2";d();var b={subscribe:f,resolveSubscription:s,getGracePeriod:a,getIdValue:n};return b}]}angular.module("sync").provider("$sync",n)}();