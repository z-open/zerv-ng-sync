!function(){"use strict";angular.module("sync",["socketio-auth"])}(),function(){"use strict";function n(){function n(n){s=n}function t(){return s}function e(){return u.length}function i(n){u.push({timestamp:Date.now(),collect:n}),c||a.schedule()}function r(){return s?(c=!0,void setTimeout(function(){a.run(),u.length>0?r():c=!1},1e3*s)):void a.run()}function o(){for(var n=Date.now()-1e3*s;u.length>0&&u[0].timestamp<=n;)u.shift().collect()}var u=[],s=2,c=!1,a={setSeconds:n,getSeconds:t,dispose:i,schedule:r,run:o,getItemCount:e};return a}angular.module("sync").factory("$syncGarbageCollector",n)}(),function(){"use strict";function n(){function n(t,i,r,o){o||_.isNil(o)?n(t,i,r):(e(t),_.assign(t,i))}function n(i,r,o){if(!i)return r;var u={};for(var s in r)_.isArray(r[s])?u[s]=t(i[s],r[s],o):_.isFunction(r[s])?u[s]=r[s]:_.isObject(r[s])&&!_.isDate(r[s])?u[s]=n(i[s],r[s],o):u[s]=r[s];return e(i),_.assign(i,u),i}function t(t,e,i){if(!t)return e;var r=[];return e.forEach(function(e){if("NONE"===i)r.push(e);else if(!_.isArray(e)&&_.isObject(e))if(angular.isDefined(e.id))r.push(n(_.find(t,function(n){return n.id.toString()===e.id.toString()}),e,i));else{if(i)throw new Error("objects in array must have an id otherwise we can't maintain the instance reference. "+JSON.stringify(e));r.push(e)}else r.push(e)}),t.length=0,Array.prototype.push.apply(t,r),t}function e(n){Object.keys(n).forEach(function(t){delete n[t]})}return{update:n,clearObject:e}}angular.module("sync").factory("$syncMerge",n)}(),function(){"use strict";function n(){function n(n){if(!_.isObject(n))return n;var t=_.join(_.map(n,function(n){return n}),"~");return t}function t(n){}function e(n){}var i;this.setDebug=function(n){i=n},this.$get=["$rootScope","$q","$socketio","$syncGarbageCollector","$syncMerge",function(i,r,o,u,s){function c(n,e,i){var o=r.defer(),u=f(n).setObjectClass(i),s=setTimeout(function(){u.ready||(u.destroy(),t("Attempt to subscribe to publication "+n+" failed"),o.reject("SYNC_TIMEOUT"))},1e3*g);return u.setParameters(e).waitForDataReady().then(function(){clearTimeout(s),o.resolve(u)})["catch"](function(){clearTimeout(s),u.destroy(),o.reject("Failed to subscribe to publication "+n+" failed")}),o.promise}function a(){return g}function f(n,t){return new h(n,t)}function d(){o.on("SYNC_NOW",function(n,e){t("Syncing with subscription [name:"+n.name+", id:"+n.subscriptionId+" , params:"+JSON.stringify(n.params)+"]. Records:"+n.records.length+"["+(n.diff?"Diff":"All")+"]");var i=p[n.name];if(i)for(var r in i)i[r](n);e("SYNCED")})}function l(n,t){var e=v++,i=p[n];return i||(p[n]=i={}),i[e]=t,function(){delete i[e]}}function h(c,a){function f(){N()}function d(n){return on&&on(),on=G(n),yn}function h(n){return n&&yn.syncOff(),yn}function p(n){return rn=n,yn}function v(n){return tn?yn:(fn=n,un=function(n){return new fn(n)},w(Q),yn)}function g(){return fn}function b(n,t){return hn&&angular.equals(n||{},pn)?yn:(N(),Q||(Z.length=0),pn=n||{},t=t||{},angular.isDefined(t.single)&&w(t.single),D(),yn)}function S(){return D().then(function(){return yn})}function O(){return D()}function w(n){if(tn)return yn;var t;return Q=n,n?(t=B,Z=fn?new fn({}):{}):(t=H,Z=[]),X=function(n){try{t(n)}catch(e){throw e.message="Received Invalid object from publication ["+c+"]: "+JSON.stringify(n)+". DETAILS: "+e.message,e}},yn}function _(){return Z}function j(){return D(),yn}function N(){return tn&&tn.resolve(_()),hn&&(J(),hn=!1,t("Sync "+c+" off. Params:"+JSON.stringify(pn)),cn&&(cn(),cn=null),sn&&(sn(),sn=null)),yn}function D(){return hn?tn.promise:(tn=r.defer(),nn=!1,t("Sync "+c+" on. Params:"+JSON.stringify(pn)),hn=!0,I(),E(),tn.promise)}function $(){return hn}function E(){cn||(C(),T())}function R(n){return tn?yn:(an&&an(),ln=n,an=ln.$on("$destroy",f),yn)}function C(n){setTimeout(function(){sn=ln.$on("user_connected",function(){e("Resyncing after network loss to "+c),I()})},n?0:2e3)}function I(){o.fetch("sync.subscribe",{version:m,id:dn,publication:c,params:pn}).then(function(n){dn=n})}function J(){dn&&(o.fetch("sync.unsubscribe",{version:m,id:dn}),dn=null)}function T(){cn=l(c,function(n){(dn===n.subscriptionId||!dn&&A(n.params))&&(n.diff||(vn={},Q||(Z.length=0)),F(n.records),nn||(nn=!0,tn.resolve(_())))})}function A(n){if(!pn||0==Object.keys(pn).length)return!0;var t=!0;for(var e in n)if(n[e]!==pn[e]){t=!1;break}return t}function F(n){var t,e=[];yn.ready=!1,n.forEach(function(n){n.remove?x(n):t=z(n)?Y(n):U(n),t&&e.push(t)}),yn.ready=!0,Q?gn.notify("ready",_()):gn.notify("ready",_(),e)}function k(){return this.ready}function M(n){return gn.on("add",n)}function P(n){return gn.on("update",n)}function q(n){return gn.on("remove",n)}function G(n){return gn.on("ready",n)}function U(n){return e("Sync -> Inserted New record #"+JSON.stringify(n.id)+" for subscription to "+c),K(n),X(un?un(n):n),gn.notify("add",n),n}function Y(n){var t=z(n);return K(n)<=K(t)?null:(e("Sync -> Updated record #"+JSON.stringify(n.id)+" for subscription to "+c),X(un?un(n):n),gn.notify("update",n),n)}function x(n){var t=z(n);(!t||K(n)>K(t))&&(e("Sync -> Removed #"+JSON.stringify(n.id)+" for subscription to "+c),n.removed=!0,X(n),t&&(gn.notify("remove",n),L(n)))}function L(t){u.dispose(function(){var e=z(t);e&&t.revision>=e.revision&&delete vn[n(t.id)]})}function V(n){return!!z(n)}function W(t){vn[n(t.id)]=t}function z(t){return vn[n(t.id)]}function B(n){W(n),n.remove?s.clearObject(Z):s.update(Z,n,rn,en)}function H(n){var t=z(n);t?(s.update(t,n,rn,en),n.removed&&Z.splice(Z.indexOf(t),1)):(W(n),n.removed||Z.push(n))}function K(n){if(angular.isDefined(n.revision))return n.revision;if(angular.isDefined(n.timestamp))return n.timestamp;throw new Error("Sync requires a revision or timestamp property in received "+(fn?"object ["+fn.name+"]":"record"))}var Q,X,Z,nn,tn,en,rn,on,un,sn,cn,an,fn,dn,ln,hn=!1,yn=this,pn={},vn={},gn=new y;this.ready=!1,this.syncOn=j,this.syncOff=N,this.setOnReady=d,this.onReady=G,this.onUpdate=P,this.onAdd=M,this.onRemove=q,this.getData=_,this.setParameters=b,this.waitForDataReady=O,this.waitForSubscriptionReady=S,this.setForce=h,this.isSyncing=$,this.isReady=k,this.setSingle=w,this.setObjectClass=v,this.getObjectClass=g,this.setStrictMode=p,this.setDeepMerge=en,this.attach=R,this.destroy=f,this.isExistingStateFor=V,w(!1),R(a||i)}function y(){function n(n,t,i){var r=e[n];r&&_.forEach(r,function(n,e){n(t,i)})}function t(n,t){var r=e[n];r||(r=e[n]={});var o=i++;return r[o++]=t,function(){delete r[o]}}var e={},i=0;this.notify=n,this.on=t}var p={},v=0,g=8,m="1.2";d();var b={subscribe:f,resolveSubscription:c,getGracePeriod:a,getIdValue:n};return b}]}angular.module("sync").provider("$sync",n)}();